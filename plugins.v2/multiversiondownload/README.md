# 多版本下载插件

> **版本：** V2 (适用于 MoviePilot V2)
> 
> **作者：** MoviePilot
>
> **功能：** 突破洗版限制，自动下载多个规则组匹配的版本

---

## 📖 功能说明

### 核心功能
- 监听订阅下载完成事件
- 根据用户选择的规则组，自动下载其他版本
- 完全复用MP的搜索和下载API，安全可靠
- 通过检查下载历史避免重复下载
- 直接调用 DownloadChain 绕过订阅的洗版检查

### 技术特点
- ✅ 完全复用MP官方API（SearchChain、DownloadChain）
- ✅ 基于种子hash精确去重
- ✅ MP自动重命名区分不同分辨率
- ✅ 支持用户自定义延迟时间
- ✅ 详细的日志输出和统计

---

## 🚀 使用方法

### 1. 前置条件

**重要：** 确保以下配置正确

1. **重命名格式包含 videoFormat**
   - 路径：设置 → 整理 → 重命名格式
   - 默认格式已包含，如自定义需确保有 `{% if videoFormat %} - {{videoFormat}}{% endif %}`

2. **覆盖模式**
   - 建议设置为 "从不覆盖" 或 "大覆盖小"
   - 路径：设置 → 目录 → 覆盖模式

3. **洗版功能**
   - 可以正常开启，插件会自动绕过洗版限制

### 2. 配置插件

1. 进入 **插件** → **多版本下载**
2. 启用插件
3. 设置延迟时间（建议15-30秒）
4. 勾选需要下载的规则组（选择 "一并保存"）
5. 保存配置

### 3. 使用

插件启用后，会自动工作：
- 当MP订阅下载完成后
- 插件等待指定时间
- 自动搜索并下载其他规则匹配的版本
- MP自动整理入库

---

## 📋 工作流程

```
用户添加订阅
  ↓
MP订阅处理
  ├─ 搜索资源
  ├─ 应用规则（例如：4K规则）
  ├─ 洗版检查
  ├─ 下载 4K 版本
  └─ 触发 DownloadAdded 事件
  
插件自动介入
  ├─ 检测到订阅下载
  ├─ 等待设定时间（确保MP完成）
  ├─ 遍历选中的规则
  │   ├─ 4K规则 → 检查历史 → 已存在 → 跳过
  │   └─ 1080P规则 → 检查历史 → 不存在 → 下载
  └─ 完成

MP自动整理
  ├─ 识别4K → 重命名：电影名 (年份) - 2160p.mkv
  └─ 识别1080P → 重命名：电影名 (年份) - 1080p.mkv

结果：两个版本共存 ✅
```

---

## 🎯 使用场景

### 场景1：多设备需求
- MP订阅下载 4K 版本（家庭影院）
- 插件自动下载 1080P 版本（移动设备）

### 场景2：版本收藏
- MP订阅下载最优版本
- 插件同时下载其他版本（多版本收藏）

### 场景3：不同来源
- 同时下载不同字幕组、不同压制组的版本

---

## ❓ 常见问题

### Q1: 为什么需要延迟时间？
**A:** 等待MP完全处理完订阅下载（包括记录历史），避免冲突。

### Q2: 会不会重复下载？
**A:** 不会。插件通过种子hash检查下载历史，相同hash会自动跳过。

### Q3: 支持洗版吗？
**A:** 完全支持。插件直接调用 DownloadChain，自动绕过订阅的洗版限制。

### Q4: 为什么版本能共存？
**A:** MP的默认重命名格式包含 `videoFormat`，会自动识别分辨率并添加到文件名，文件名不同自然不会冲突。

### Q5: 需要配置下载路径吗？
**A:** 不需要。插件使用MP的默认逻辑，会根据媒体类型和类别自动匹配目录。

---

## 📝 更新日志

### v1.0.0 (2025-11-03)
- 首次发布
- 支持自动下载多个规则组匹配的版本
- 完全复用MP官方API
- 基于hash精确去重
- 用户可配置延迟时间

---

## 🔧 技术细节

### 核心API调用

```python
# 搜索（指定规则组）
contexts = SearchChain().process(
    mediainfo=mediainfo,
    rule_groups=[rule_name]
)

# 检查历史
history = DownloadHistoryOper().get_by_hash(torrent.hash)

# 下载（绕过洗版）
download_id = DownloadChain().download_single(
    context=best_context,
    username="MultiVersionDownload",
    source="MultiVersion"
)
```

### 为什么能绕过洗版？

- **洗版检查只在 SubscribeChain**
- **DownloadChain 不检查洗版**
- **插件直接调用 DownloadChain = 绕过限制**

---

## ⚠️ 注意事项

1. **确保重命名格式包含 videoFormat**，否则不同版本会互相覆盖
2. **建议覆盖模式设为 "从不覆盖"**，避免意外覆盖
3. **延迟时间不要太短**，建议15-30秒
4. **选择规则时注意**，勾选的规则都会触发下载

---

## 📞 反馈与支持

如有问题或建议，请在 MoviePilot 项目中提交 Issue。

---

**享受多版本收藏的乐趣吧！** 🎉

